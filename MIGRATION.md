# Tally Desktop - Tauri SPA Migration

## Overview

Tally has been successfully migrated from TanStack Start (SSR web app) to a unified Tauri Desktop SPA application.

## What Changed

### 1. Build System
- **Removed**: TanStack Start with SSR/Nitro
- **New**: Pure Vite + TanStack Router SPA build
- Single entry point: `src/main.tsx`
- All routes are now client-side only

### 2. Dependencies Updated
**Removed:**
- `@tanstack/react-start`
- `@tanstack/react-router-ssr-query`
- `nitro`
- `@tanstack/devtools-vite`

**Added:**
- `@tauri-apps/plugin-http` - For Basiq bank integration
- `@tauri-apps/plugin-sql` - SQLite persistence (already in use)

### 3. Project Structure
```
src/
├── main.tsx              # SPA entry point (new)
├── routeTree.gen.ts      # Generated TanStack Router routes
├── routes/               # All 56+ routes (unchanged logic)
│   ├── __root.tsx        # Updated: Removed SSR shellComponent
│   ├── dashboard.tsx
│   ├── receipts.tsx
│   ├── accountant-portal.tsx
│   └── ... (all other routes)
├── lib/
│   └── db.ts             # SQLite via tauri-plugin-sql (unchanged)
└── components/           # All components (unchanged)

src-tauri/
├── Cargo.toml            # Added sql and http plugins
├── src/
│   ├── lib.rs            # Added plugin initialization
│   ├── main.rs
│   ├── ocr.rs            # OCR Rust commands
│   ├── invoice.rs        # Invoice parsing
│   └── tax_report.rs     # PDF generation
└── tauri.conf.json       # Updated permissions
```

### 4. Key Configuration Files

#### vite.config.ts
- Removed `tanstackStart()` plugin
- Added `TanStackRouterVite()` for SPA routing
- Tauri-optimized build settings

#### tauri.conf.json
- Updated app identifier: `com.tally.desktop`
- Added SQL permissions: `sql:allow-load`, `sql:allow-execute`, `sql:allow-select`
- Added HTTP permissions for Basiq integration
- Enhanced filesystem permissions for document storage

### 5. Database Layer
The SQLite database layer (`src/lib/db.ts`) required **no changes** - it was already using `tauri-plugin-sql` which is the correct approach for Tauri apps.

### 6. API Routes Removed
- Removed `src/routes/api/` directory (TanStack Start API routes)
- All functionality moved to:
  - Tauri commands (Rust)
  - Direct SQLite calls via `tauri-plugin-sql`
  - Client-side processing

## Features Migrated

All features from the web app are now available in the desktop build:

### Core Features ✅
- [x] Dashboard with spending insights
- [x] Receipt management with categories
- [x] SQLite persistence via `tauri-plugin-sql`
- [x] OCR receipt scanning
- [x] Tax year management
- [x] Income tracking

### ATO Categories (D1-D15) ✅
- [x] D1 - Car Expenses & Vehicle Logbook
- [x] D2 - Travel Expenses
- [x] D3 - Clothing & Laundry
- [x] D4 - Self-Education
- [x] D5 - Other Work Expenses
- [x] D6 - Low-Value Pool
- [x] D7 - Interest & Dividends
- [x] D8 - Donations
- [x] D9 - Tax Affairs
- [x] D10 - Medical
- [x] D11 - UPP
- [x] D12 - Super
- [x] D13 - Project Pool
- [x] D14 - Forestry
- [x] D15 - Other Deductions

### Advanced Features ✅
- [x] Bank integration (Basiq) - via Tauri HTTP plugin
- [x] Tax calculator
- [x] Accountant portal
- [x] Contextual questions/quizzes
- [x] Tax reports with PDF export
- [x] Workpaper library
- [x] Document detection
- [x] Dividend tracking
- [x] Franking credits
- [x] Weekly digest
- [x] Upload reminders
- [x] Completeness check

## How to Run

### Development
```bash
# Install dependencies
npm install

# Run Tauri dev (builds Rust + Vite)
npm run tauri-dev
```

### Production Build
```bash
# Build the complete desktop app
npm run tauri-build
```

## Technical Details

### State Management
- TanStack Router for routing state
- React hooks for local state
- SQLite for persistent data
- No server-side state (pure SPA)

### Database
- **Engine**: SQLite via `tauri-plugin-sql`
- **Location**: `~/.local/share/tally-desktop/default.db` (Linux)
  - macOS: `~/Library/Application Support/com.tally.desktop/default.db`
  - Windows: `%APPDATA%\tally-desktop\default.db`
- **Schema**: Receipts, Income, Tax Years, Workpapers, ATO Categories, etc.

### Security
- CSP configured in `tauri.conf.json`
- Capabilities-based permission system
- Local filesystem access restricted to app directories
- HTTP requests allowed for Basiq API

## Migration Benefits

1. **No Server Required**: Runs entirely on the user's machine
2. **Better Performance**: No network latency for database operations
3. **Offline-First**: Works without internet (except bank sync)
4. **Data Privacy**: All data stays on user's device
5. **Native Features**: File system, native dialogs, system tray (future)
6. **Single Codebase**: Web and desktop share the same React components
7. **Simpler Deployment**: One binary to distribute

## Notes

- The `routeTree.gen.ts` file is auto-generated by TanStack Router
- All React components work without modification
- The camera/OCR flow now saves directly to the filesystem via Tauri
- PDF generation happens in Rust for better performance

## Troubleshooting

### Database Issues
If you encounter database errors:
```bash
# The database will auto-initialize on first run
# To reset, delete the database file:
rm ~/.local/share/tally-desktop/default.db  # Linux
rm ~/Library/Application\ Support/com.tally.desktop/default.db  # macOS
```

### Build Issues
```bash
# Clean and rebuild
rm -rf node_modules dist src-tauri/target
npm install
npm run tauri-build
```

## Next Steps (Optional Enhancements)

1. **Auto-Updater**: Add Tauri updater for automatic updates
2. **System Tray**: Minimize to tray functionality
3. **Global Shortcut**: Quick add receipt shortcut
4. **Notifications**: Native OS notifications for reminders
5. **Backup/Restore**: Cloud backup options
